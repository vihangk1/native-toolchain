From 7ab8436803f453e6c5d64d825ed9124400a285c4 Mon Sep 17 00:00:00 2001
From: Vihang Karajgaonkar <vihangk1@apache.org>
Date: Tue, 9 Feb 2021 13:38:34 -0800
Subject: [PATCH] Catch errors around ThriftDebugString

---
 .../src/thrift/protocol/TDebugProtocol.cpp    | 15 +++++++++++++
 lib/cpp/src/thrift/protocol/TDebugProtocol.h  | 21 +++++++++++++++++--
 2 files changed, 34 insertions(+), 2 deletions(-)

diff --git a/lib/cpp/src/thrift/protocol/TDebugProtocol.cpp b/lib/cpp/src/thrift/protocol/TDebugProtocol.cpp
index 4687e82f..51f5c902 100644
--- a/lib/cpp/src/thrift/protocol/TDebugProtocol.cpp
+++ b/lib/cpp/src/thrift/protocol/TDebugProtocol.cpp
@@ -168,9 +168,24 @@ uint32_t TDebugProtocol::writeItem(const std::string& str) {
   size += startItem();
   size += writePlain(str);
   size += endItem();
+  checkCurrentSize(size);
   return size;
 }
 
+void TDebugProtocol::checkCurrentSize(const uint32_t size) {
+  if (max_output_limit_ <= 0) {
+    return;
+  }
+  current_output_size_ += size;
+  if (current_output_size_ > max_output_limit_) {
+    std::string msg = "VIHANG-DEBUG: Max size ";
+    msg.append(std::to_string(max_output_limit_));
+    msg.append(" current size ");
+    msg.append(std::to_string(current_output_size_));
+    throw new TProtocolException(msg);
+  }
+}
+
 uint32_t TDebugProtocol::writeMessageBegin(const std::string& name,
                                            const TMessageType messageType,
                                            const int32_t seqid) {
diff --git a/lib/cpp/src/thrift/protocol/TDebugProtocol.h b/lib/cpp/src/thrift/protocol/TDebugProtocol.h
index cc932302..56147e83 100644
--- a/lib/cpp/src/thrift/protocol/TDebugProtocol.h
+++ b/lib/cpp/src/thrift/protocol/TDebugProtocol.h
@@ -66,6 +66,8 @@ public:
 
   void setStringPrefixSize(int32_t string_prefix_size) { string_prefix_size_ = string_prefix_size; }
 
+  void setMaxOutputSizeLimit(int32_t max_limit) { max_output_limit_ = max_limit; }
+
   uint32_t writeMessageBegin(const std::string& name,
                              const TMessageType messageType,
                              const int32_t seqid);
@@ -118,6 +120,7 @@ private:
   uint32_t startItem();
   uint32_t endItem();
   uint32_t writeItem(const std::string& str);
+  void checkCurrentSize(uint32_t size);
 
   static std::string fieldTypeName(TType type);
 
@@ -125,6 +128,8 @@ private:
 
   int32_t string_limit_;
   int32_t string_prefix_size_;
+  uint32_t max_output_limit_;
+  uint32_t current_output_size_;
 
   std::string indent_str_;
   static const int indent_inc = 2;
@@ -157,13 +162,25 @@ namespace thrift {
 
 template <typename ThriftStruct>
 std::string ThriftDebugString(const ThriftStruct& ts) {
+  return ThriftDebugString(ts, 0);
+}
+
+template <typename ThriftStruct>
+std::string ThriftDebugString(const ThriftStruct& ts, int32_t max_output_size) {
   using namespace apache::thrift::transport;
   using namespace apache::thrift::protocol;
   TMemoryBuffer* buffer = new TMemoryBuffer;
   boost::shared_ptr<TTransport> trans(buffer);
   TDebugProtocol protocol(trans);
-
-  ts.write(&protocol);
+  protocol.setMaxOutputSizeLimit(max_output_size);
+
+  try {
+    ts.write(&protocol);
+  } catch(TException& e) {
+    return "Unable to write object due to error: " + std::string(e.what());
+  } catch (std::bad_alloc& ba) {
+    return "Caught bad_alloc error: " + std::string(ba.what());
+  }
 
   uint8_t* buf;
   uint32_t size;
-- 
2.17.1

